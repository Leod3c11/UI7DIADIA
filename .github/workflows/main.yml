name: Kernel Build Exynos 9830 (LLVM 12 + Simple LMK)

on:
  workflow_dispatch:

env:
  LLVM_VER: "12"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4

      - name: Add simple_lmk submodule
        run: |
          rm -rf drivers/android/simple_lmk
          git submodule add -b linux-4.19 https://github.com/kerneltoast/simple_lmk.git drivers/android/simple_lmk || true
          git submodule update --init --recursive
          ls drivers/android/simple_lmk/drivers/android/simple_lmk.c || echo "Submodule added!"

      - name: Clean up old LLVM versions
        run: |
          sudo apt remove --purge -y llvm-14 clang-14 lld-14 || true
          sudo apt autoremove -y
          sudo rm -rf /usr/lib/llvm-14 /usr/bin/llvm-*14 /usr/bin/clang-14 /usr/bin/lld-14

      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y --allow-change-held-packages \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev libncurses5-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            clang-12 lld-12 llvm-12 llvm-12-tools \
            zip wget

      - name: Create LLVM symlinks
        run: |
          sudo ln -sf /usr/bin/clang-12    /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-12  /usr/bin/clang++
          sudo ln -sf /usr/bin/llvm-ar-12  /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-12  /usr/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-objcopy-12 /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-objdump-12 /usr/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-strip-12 /usr/bin/llvm-strip
          sudo ln -sf /usr/bin/ld.lld-12   /usr/bin/ld.lld
          sudo ln -sf /usr/bin/ld.lld-12   /usr/bin/lld

          clang --version | grep "clang version 12" || { echo "Erro: clang versão errada"; exit 1; }
          ld.lld --version | grep "LLD 12" || { echo "Erro: ld.lld versão errada"; exit 1; }

      - name: Setup environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "CC=ccache clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "NM=llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
          echo "STRIP=llvm-strip" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV

          ccache -C
          ccache -M 10G
          ccache -s

      - name: Clean build directory
        run: rm -rf out/

      - name: Defconfig
        run: make O=out exynos9830_defconfig r8s.config

      - name: Enable CONFIG_ANDROID_SIMPLE_LMK
        run: |
          # Adiciona ou atualiza o config no .config
          sed -i '/CONFIG_ANDROID_SIMPLE_LMK/d' out/.config || true
          echo "CONFIG_ANDROID_SIMPLE_LMK=y" >> out/.config
          
          # Atualiza o config (resolve dependências)
          make O=out olddefconfig

      - name: Build kernel
        run: make O=out -j$(nproc)

      - name: Build AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel
          rm -rf anykernel/.git anykernel/README.md
          cp out/arch/arm64/boot/Image.gz anykernel/ || cp out/arch/arm64/boot/Image anykernel/
          cd anykernel
          zip -r9 ../AnyKernel3-Exynos9830.zip *

      - name: Build boot.img
        run: |
          export MODEL=r8s
          export BOARD=exynos9830
          mkdir -p build/out/$MODEL
          cp out/arch/arm64/boot/Image build/out/$MODEL/

          toolchain/mkdtimg cfg_create build/out/$MODEL/dtb.img build/dtconfigs/exynos9830.cfg -d out/arch/arm64/boot/dts/exynos
          toolchain/mkdtimg cfg_create build/out/$MODEL/dtbo.img build/dtconfigs/$MODEL.cfg -d out/arch/arm64/boot/dts/samsung

          pushd build/ramdisk
          find . ! -name . | LC_ALL=C sort | cpio -o -H newc -R root:root | gzip > ../out/$MODEL/ramdisk.cpio.gz
          popd

          toolchain/mkbootimg \
            --board $BOARD \
            --kernel build/out/$MODEL/Image \
            --ramdisk build/out/$MODEL/ramdisk.cpio.gz \
            --dtb build/out/$MODEL/dtb.img \
            --header_version 2 \
            --pagesize 2048 \
            -o build/out/$MODEL/boot.img

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-artifacts
          path: |
            build/out/r8s/boot.img
            build/out/r8s/dtb.img
            build/out/r8s/dtbo.img
            AnyKernel3-Exynos9830.zip
