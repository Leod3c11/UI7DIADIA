name: Kernel Build Exynos 9830 (Clang r450784d Android 13 + ThinLTO)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y --allow-change-held-packages \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev libncurses5-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
            zip wget tar xz-utils

      - name: Download and setup Clang r450784d (Android 13)
        run: |
          mkdir -p toolchain/clang_r450784d
          cd toolchain/clang_r450784d
          curl -L -o clang.tar.gz https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-13.0.0_r13/clang-r450784d.tar.gz
          tar xf clang.tar.gz
          rm clang.tar.gz
          echo "Clang version:"
          ./bin/clang --version

      - name: Setup environment (ThinLTO + otimizações)
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV
          echo "CC=ccache $GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/clang" >> $GITHUB_ENV
          echo "CXX=ccache $GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/clang++" >> $GITHUB_ENV
          echo "LD=$GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/ld.lld" >> $GITHUB_ENV
          echo "AR=$GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/llvm-ar" >> $GITHUB_ENV
          echo "NM=$GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=$GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/llvm-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=$GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/llvm-objdump" >> $GITHUB_ENV
          echo "STRIP=$GITHUB_WORKSPACE/toolchain/clang_r450784d/bin/llvm-strip" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV

          # ThinLTO + otimizações agressivas
          echo "KBUILD_CFLAGS=-flto=thin -fwhole-program-vtables -O3 -march=armv8.2-a+crc -mtune=cortex-a77" >> $GITHUB_ENV
          echo "KBUILD_LDFLAGS=-flto=thin" >> $GITHUB_ENV

          ccache -C
          ccache -M 12G
          ccache -s

      - name: Clean build directory
        run: rm -rf out/

      - name: Defconfig
        run: make O=out exynos9830_defconfig r8s.config

      - name: Build kernel
        run: make O=out -j$(nproc)

      - name: Build AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel
          rm -rf anykernel/.git anykernel/README.md
          cp out/arch/arm64/boot/Image.gz anykernel/ || cp out/arch/arm64/boot/Image anykernel/
          cd anykernel
          zip -r9 ../AnyKernel3-Exynos9830.zip *

      - name: Build boot.img
        run: |
          export MODEL=r8s
          export BOARD=exynos9830
          mkdir -p build/out/$MODEL
          cp out/arch/arm64/boot/Image build/out/$MODEL/

          toolchain/mkdtimg cfg_create build/out/$MODEL/dtb.img build/dtconfigs/exynos9830.cfg -d out/arch/arm64/boot/dts/exynos
          toolchain/mkdtimg cfg_create build/out/$MODEL/dtbo.img build/dtconfigs/$MODEL.cfg -d out/arch/arm64/boot/dts/samsung

          pushd build/ramdisk
          find . ! -name . | LC_ALL=C sort | cpio -o -H newc -R root:root | gzip > ../out/$MODEL/ramdisk.cpio.gz
          popd

          toolchain/mkbootimg \
            --board $BOARD \
            --kernel build/out/$MODEL/Image \
            --ramdisk build/out/$MODEL/ramdisk.cpio.gz \
            --dtb build/out/$MODEL/dtb.img \
            --header_version 2 \
            --pagesize 2048 \
            -o build/out/$MODEL/boot.img

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-artifacts
          path: |
            build/out/r8s/boot.img
            build/out/r8s/dtb.img
            build/out/r8s/dtbo.img
            AnyKernel3-Exynos9830.zip
